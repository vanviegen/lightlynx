# AGENTS.md - Light Lynx

## Project Overview

**Light Lynx** is a modern, fast web application for controlling Zigbee2MQTT smart lights and devices. It provides a mobile-friendly PWA (Progressive Web App) interface for managing Zigbee smart home lighting with features like color picking, groups, scenes, and device management.

## Tech Stack

- **Language**: TypeScript
- **UI Framework**: [Aberdeen](https://github.com/vanviegen/aberdeen) - a reactive UI library with proxy-based state management
- **Build Tool**: Vite 6.x
- **Backend**: Connects to Zigbee2MQTT via WebSocket
- **PWA**: Service Worker for offline caching and stale-while-revalidate strategy

## Project Structure

```
src/
├── app.ts           # Main application - routing, UI components, device/group views
├── api.ts           # WebSocket API client for Zigbee2MQTT communication
├── types.ts         # TypeScript interfaces (Device, Group, LightState, etc.)
├── color-picker.ts  # Color wheel and brightness picker UI components
├── colors.ts        # Color conversion utilities (HSV, RGB, XY, mireds)
├── icons.ts         # SVG icon components
├── sw.ts            # Service Worker for PWA caching
├── style.css        # Application styles
└── index.html       # HTML entry point

public/              # Built output (generated by Vite)
```

## Key Concepts

### State Management
Uses Aberdeen's `proxy()` for reactive state. The global store (`api.store`) contains:
- `devices`: Record of devices keyed by IEEE address
- `groups`: Record of groups keyed by group ID
- `permit_join`: Boolean for pairing mode
- `credentials`: WebSocket URL and token for Z2M connection
- `extensions`: Z2M extensions list

### Color Systems
The app handles multiple color representations:
- **HSColor**: `{ hue: 0-360, saturation: 0-1 }`
- **XYColor**: `{ x: number, y: number }` (CIE color space)
- **Color Temperature**: Mireds (number)

### Device Types
- **Lights**: Devices with `lightCaps` property (brightness, color, color_temp support)
- **Sensors/Inputs**: Devices without `lightCaps` (buttons, switches, motion sensors)

### Groups
Groups can contain lights and have associated scenes. Non-light devices can be linked to groups via the `description` field using `groups=1,2,3` syntax.

## NPM Scripts

```bash
npm run dev      # Start Vite dev server with hot reload
npm run build    # Production build to public/
npm run watch    # Build in watch mode
```

## API Communication

The app communicates with Zigbee2MQTT via WebSocket:
- Connection URL and token stored in localStorage
- Messages follow Z2M's topic-based format: `api.send(topic, ...path, payload)`
- Light state changes use optimistic updates with debouncing

## Code Conventions

- Use Aberdeen's `$()` function for reactive DOM rendering
- Components are functions that call `$()` to render DOM elements
- Routing via `aberdeen/route` with path-based navigation
- Icons are SVG functions from `icons.ts`
- Admin mode toggled via `?admin=y` query parameter

## Important Patterns

### Reactive Rendering
```typescript
$(() => {
    // This block re-runs when any accessed proxy values change
    $('div.item#', device.name);
});
```

### Event Handling
```typescript
$('div.button click=', () => {
    // Click handler
});
```

### Conditional Admin Features
Many features check `admin.value` to show/hide configuration options.

## Service Worker

The service worker implements stale-while-revalidate caching:
- Serves cached responses immediately
- Revalidates in background
- Triggers page reload when updates detected

## Z2M Extension

The app can auto-install/update a custom Zigbee2MQTT extension (`z2m-extension.js`) for automation features. Version checking is done via first-line comments.
